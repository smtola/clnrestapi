from flask import Flask, request, jsonify, send_from_directory
from flask_swagger_ui import get_swaggerui_blueprint

app = Flask(__name__)

# In-memory "database"
items = {}
item_id_counter = 1

# Simple token for demonstration
API_TOKEN = "SECRET123"

# Swagger setup
SWAGGER_URL = '/docs'
API_URL = '/api/v1/swagger.json'
swaggerui_blueprint = get_swaggerui_blueprint(
    SWAGGER_URL, API_URL, config={'app_name': "Test Flask Swagger CRUD"}
)
app.register_blueprint(swaggerui_blueprint, url_prefix=SWAGGER_URL)

@app.route("/api/v1/swagger.json")
def swagger_json():
    return send_from_directory('static', 'swagger.json')

# --- Authorization decorator ---
def require_auth(func):
    def wrapper(*args, **kwargs):
        token = request.headers.get('Authorization')
        if token != f"Bearer {API_TOKEN}":
            return jsonify({"error": "Unauthorized"}), 401
        return func(*args, **kwargs)
    wrapper.__name__ = func.__name__
    return wrapper

# --- CRUD Endpoints ---

@app.route('/items', methods=['GET'])
@require_auth
def get_items():
    """Get all items"""
    return jsonify(list(items.values()))

@app.route('/items/<int:item_id>', methods=['GET'])
@require_auth
def get_item(item_id):
    """Get item by ID"""
    item = items.get(item_id)
    if not item:
        return jsonify({"error": "Not found"}), 404
    return jsonify(item)

@app.route('/items', methods=['POST'])
@require_auth
def create_item():
    """Create a new item"""
    global item_id_counter
    data = request.get_json()
    item = {"id": item_id_counter, "name": data["name"]}
    items[item_id_counter] = item
    item_id_counter += 1
    return jsonify(item), 201

@app.route('/items/<int:item_id>', methods=['PUT'])
@require_auth
def update_item(item_id):
    """Update an item"""
    item = items.get(item_id)
    if not item:
        return jsonify({"error": "Not found"}), 404
    data = request.get_json()
    item["name"] = data["name"]
    return jsonify(item)

@app.route('/items/<int:item_id>', methods=['DELETE'])
@require_auth
def delete_item(item_id):
    """Delete an item"""
    if item_id in items:
        del items[item_id]
        return '', 204
    else:
        return jsonify({"error": "Not found"}), 404

if __name__ == "__main__":
    app.run(debug=True)